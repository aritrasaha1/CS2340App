<!-- CS2340App/templates/restaurants/restaurant_detail.html -->
{% extends 'base.html' %}

{% block extra_head %}
    <!-- Include Google Maps JavaScript API with callback -->
    <script src="https://maps.googleapis.com/maps/api/js?key={{ GOOGLE_MAPS_API_KEY }}&callback=initMap" async defer></script>
    <!-- Include SweetAlert and jQuery -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
{% endblock %}

{% block content %}
    <div class="container">
        {% if error %}
            <p>{{ error }}</p>
        {% else %}
            <h2>{{ details.name|default:"Unknown" }}</h2>
            <p><strong>Address:</strong> {{ details.formatted_address|default:"No address available" }}</p>
            <p><strong>Phone:</strong> {{ details.formatted_phone_number|default:"No phone number available" }}</p>
            <p><strong>Cuisine Type:</strong> {{ details.cuisine_type|default:"Unknown" }}</p>
            <p><strong>Rating:</strong> {{ details.rating|default:"No rating available" }}</p>
            <p><strong>Opening Hours:</strong></p>
            <ul>
                {% if details.opening_hours %}
                    {% for day in details.opening_hours.weekday_text %}
                        <li>{{ day }}</li>
                    {% endfor %}
                {% else %}
                    <li>No hours available</li>
                {% endif %}
            </ul>
            <p><strong>Directions:</strong> <a href="https://www.google.com/maps/dir/?api=1&destination={{ latitude }},{{ longitude }}" target="_blank" class="btn">Get Directions</a></p>
            <!-- Google Map Showing Restaurant Location -->
            <div id="map" style="width: 100%; height: 400px; margin-top: 20px;"></div>
            
            <!-- Google Reviews -->
            <h3>Google Reviews:</h3>
            <div class="google-reviews">
                {% if google_reviews %}
                    {% for review in google_reviews %}
                        <div class="google-review">
                            <h4>{{ review.author_name }} - Rating: {{ review.rating }}</h4>
                            <p>{{ review.text }}</p>
                            <p><em>{{ review.relative_time_description }}</em></p>
                        </div>
                    {% endfor %}
                {% else %}
                    <p>No Google reviews available.</p>
                {% endif %}
            </div>

            <!-- User Reviews -->
            <h3>Your Reviews:</h3>
            <div class="reviews">
                {% for review in user_reviews %}
                    <div class="review">
                        <h4>{{ review.user.username }} - Rating: {{ review.rating }}</h4>
                        <p>{{ review.comment }}</p>
                        <p><em>Posted on {{ review.created_at|date:"F j, Y, g:i a" }}</em></p>
                    </div>
                {% empty %}
                    <p>No reviews yet. Be the first to review!</p>
                {% endfor %}
            </div>

            <!-- Review Submission Form -->
            <h3>Write a Review:</h3>
            <div class="review-form">
                <form method="post">
                    {% csrf_token %}
                    {{ form.as_p }}
                    <button type="submit" class="btn">Submit Review</button>
                </form>
            </div>

            <!-- Favorite Button -->
            {% if user.is_authenticated %}
                {% if is_favorite %}
                    <button id="remove-favorite" class="btn remove favorite-button" data-place-id="{{ details.place_id }}">Remove from Favorites</button>
                {% else %}
                    <button id="add-favorite" class="btn add favorite-button" data-place-id="{{ details.place_id }}" data-name="{{ details.name|default:"Unknown" }}" data-address="{{ details.formatted_address|default:"No address available" }}" data-rating="{{ details.rating|default:"" }}">Add to Favorites</button>
                {% endif %}
            {% else %}
                <p><a href="{% url 'login' %}" class="btn">Login</a> to save this restaurant to your favorites.</p>
            {% endif %}

            <!-- Back to Map -->
            <p><a href="{% url 'map' %}" class="btn" style="background-color: #555;">Back to Map</a></p>
        {% endif %}
    </div>

    <!-- JavaScript for Map and Favorite Functionality -->
    <script>
        // Initialize Google Map
        function initMap() {
            const restaurantLocation = { lat: parseFloat('{{ latitude }}'), lng: parseFloat('{{ longitude }}') };
            const map = new google.maps.Map(document.getElementById('map'), {
                center: restaurantLocation,
                zoom: 15
            });

            const marker = new google.maps.Marker({
                position: restaurantLocation,
                map: map,
                title: '{{ details.name|default:"Unknown" }}'
            });

            // Optional: Add InfoWindow with Directions Link
            const infoWindow = new google.maps.InfoWindow({
                content: '<p><strong>{{ details.name|default:"Unknown" }}</strong><br>' +
                         '<a href="https://www.google.com/maps/dir/?api=1&destination={{ latitude }},{{ longitude }}" target="_blank" class="btn" style="background-color: #555;">Get Directions</a></p>'
            });

            marker.addListener('click', () => {
                infoWindow.open(map, marker);
            });
        }

        // CSRF Token Setup for AJAX
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let cookie of cookies) {
                    cookie = cookie.trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        const csrftoken = getCookie('csrftoken');
        $.ajaxSetup({
            beforeSend: function(xhr, settings) {
                if (!/^GET|HEAD|OPTIONS|TRACE$/i.test(settings.type) && !this.crossDomain) {
                    xhr.setRequestHeader("X-CSRFToken", csrftoken);
                }
            }
        });
        $(document).ready(function(){
            $('#add-favorite').click(function(){
                const place_id = $(this).data('place-id');
                const name = $(this).data('name');
                const address = $(this).data('address');
                const rating = $(this).data('rating');
                addFavorite(place_id, name, address, rating);
            });
            $('#remove-favorite').click(function(){
                const place_id = $(this).data('place-id');
                Swal.fire({
                    title: 'Are you sure?',
                    text: "Do you want to remove this restaurant from your favorites?",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#ff6347',
                    cancelButtonColor: '#aaa',
                    confirmButtonText: 'Yes, remove it!'
                }).then((result) => {
                    if (result.isConfirmed) {
                        removeFavorite(place_id);
                    }
                });
            });
        });
        function addFavorite(place_id, name, address, rating) {
            if (!place_id) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Place ID is missing. Cannot add to favorites.',
                });
                return;
            }
            $.ajax({
                url: "{% url 'add_favorite' %}",
                method: "POST",
                data: {
                    'place_id': place_id,
                    'name': name,
                    'address': address,
                    'rating': rating
                },
                success: function(response){
                    Swal.fire({
                        icon: 'success',
                        title: 'Success',
                        text: response.message,
                        timer: 2000,
                        showConfirmButton: false
                    });
                    location.reload();  // Reload to update favorite status
                },
                error: function(xhr){
                    const errorMsg = xhr.responseJSON && xhr.responseJSON.message ? xhr.responseJSON.message : 'An error occurred.';
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: errorMsg,
                    });
                }
            });
        }
        function removeFavorite(place_id) {
            if (!place_id) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Place ID is missing. Cannot remove from favorites.',
                });
                return;
            }
            $.ajax({
                url: "{% url 'remove_favorite' 'PLACE_ID' %}".replace('PLACE_ID', place_id),
                method: "POST",
                success: function(response){
                    Swal.fire({
                        icon: 'success',
                        title: 'Removed!',
                        text: response.message,
                        timer: 2000,
                        showConfirmButton: false
                    });
                    location.reload();  // Reload to update favorite status
                },
                error: function(xhr){
                    const errorMsg = xhr.responseJSON && xhr.responseJSON.message ? xhr.responseJSON.message : 'An error occurred.';
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: errorMsg,
                    });
                }
            });
        }
    </script>
{% endblock %}
